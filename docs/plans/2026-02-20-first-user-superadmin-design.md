# First-User Superadmin Bootstrap — Design

**Date:** 2026-02-20
**Status:** Approved

## Goal

When the first user registers via Clerk, automatically assign them the `superadmin` role. All subsequent users receive the default `role = 'user'`. The promotion must be race-safe.

## Approach

Use a single atomic SQL `INSERT ... ON CONFLICT` statement with a `CASE` subquery to determine the role at the database layer. No migration is required — the `role` column already exists (migration 000003).

## SQL Query

Replace the existing `UpsertByClerkID` query with `UpsertUserWithRole`:

```sql
-- name: UpsertUserWithRole :exec
INSERT INTO users (clerk_id, username, name, email, role, is_active, created_at, updated_at)
VALUES (
  $1, $2, $3, $4,
  CASE WHEN (SELECT COUNT(*) FROM users WHERE deleted_at IS NULL) = 0
       THEN 'superadmin'
       ELSE 'user'
  END,
  TRUE, NOW(), NOW()
)
ON CONFLICT (clerk_id) DO UPDATE
SET username   = EXCLUDED.username,
    name       = EXCLUDED.name,
    email      = COALESCE(EXCLUDED.email, users.email),
    updated_at = NOW();
```

**Why this is race-safe:** The `CASE` subquery and the `INSERT` are evaluated atomically by PostgreSQL in a single statement. Two simultaneous inserts cannot both see `COUNT = 0`.

**Why `deleted_at IS NULL`:** Counts only active (non-soft-deleted) users, so a fresh environment with only ghost rows correctly promotes the new user.

**Why `role` is absent from `DO UPDATE SET`:** An existing user's role is never overwritten by a subsequent `user.updated` webhook from Clerk.

## Go Changes

### `queries/users.sql`
- Replace `UpsertByClerkID` with `UpsertUserWithRole` (query above).
- All other queries unchanged.

### `internal/db/` (auto-generated)
- Run `sqlc generate` from `backend/`.
- Produces `UpsertUserWithRoleParams` (same 4 fields: `ClerkID`, `Username`, `Name`, `Email`) and `UpsertUserWithRole` method.
- Removes old `UpsertByClerkID` and its params struct.

### `main.go`
- In the `user.created` / `user.updated` webhook case, replace `q.UpsertByClerkID(...)` with `q.UpsertUserWithRole(...)`.
- Call site and params are identical — no structural change to the handler.

## Behaviour

| Scenario | Result |
|---|---|
| First user ever registers | `role = 'superadmin'` |
| Second+ user registers | `role = 'user'` |
| Existing user updates profile (`user.updated`) | Role preserved unchanged |
| All users soft-deleted, then new user registers | `role = 'superadmin'` |
| Two users register simultaneously | One atomically wins `COUNT=0`; only one superadmin |

## Files Touched

| File | Action |
|---|---|
| `backend/queries/users.sql` | Modify — replace `UpsertByClerkID` with `UpsertUserWithRole` |
| `backend/internal/db/users.sql.go` | Auto-generated by sqlc |
| `backend/internal/db/querier.go` | Auto-generated by sqlc |
| `backend/main.go` | Modify — update webhook handler call site |
