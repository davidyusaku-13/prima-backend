# Soft Delete + clerk_id as Primary Key — Design

**Date:** 2026-02-20
**Status:** Approved

## Goal

1. When a user is deleted from the Clerk dashboard, soft-delete their DB row instead of hard-deleting it.
2. Fix the `UpsertUserWithRole` `ON CONFLICT` clause to reset soft-delete fields if a row is re-upserted.
3. Drop the internal `id BIGINT SERIAL` column and promote `clerk_id TEXT` to `PRIMARY KEY`.

---

## Change 1: `user.deleted` webhook → soft delete

### Current behavior

The `user.deleted` Clerk webhook calls `q.DeleteUserByClerkID(...)`, which issues a `DELETE FROM users WHERE clerk_id = $1` — permanently removing the row.

### New behavior

The `user.deleted` webhook calls `q.SoftDeleteUserByClerkID(...)` instead, which sets:

```sql
SET deleted_at = NOW(), is_active = FALSE, updated_at = NOW()
WHERE clerk_id = $1
```

The row is preserved with an audit trail. `SoftDeleteUserByClerkID` already exists in the query layer and is already generated — only the call site in `main.go` changes.

### Behavior table

| Scenario | Before | After |
|---|---|---|
| Clerk deletes user | Hard delete (row gone) | Soft delete (`deleted_at=NOW(), is_active=false`) |
| User re-registers (new `clerk_id`) | New row | New row; old row preserved |
| First active user after all soft-deleted | `role = 'superadmin'` (correct) | Same — `NOT EXISTS ... deleted_at IS NULL` still correct |

`DeleteUserByClerkID` query is retained (not removed) for potential admin hard-purge use in the future.

---

## Change 2: Fix `ON CONFLICT` to reset soft-delete fields

### Problem

`UpsertUserWithRole` has an `ON CONFLICT (clerk_id) DO UPDATE SET` clause that updates `username`, `name`, `email`, and `updated_at` — but does **not** reset `is_active` or `deleted_at`. If a soft-deleted row's `clerk_id` were ever re-upserted (e.g., manual seeding, test fixtures), the user would remain marked as deleted.

### Fix

Add `is_active = TRUE, deleted_at = NULL` to the `DO UPDATE SET` clause:

```sql
ON CONFLICT (clerk_id) DO UPDATE
SET username   = EXCLUDED.username,
    name       = EXCLUDED.name,
    email      = COALESCE(EXCLUDED.email, users.email),
    is_active  = TRUE,
    deleted_at = NULL,
    updated_at = NOW();
```

`role` remains intentionally absent from `DO UPDATE SET` — an existing user's role is never overwritten by Clerk webhooks.

---

## Change 3: Drop `id`, promote `clerk_id` to `PRIMARY KEY`

### Rationale

The `id BIGINT SERIAL` column is an internal auto-increment key that adds no value when `clerk_id` already serves as the unique identity anchor. `clerk_id` is already `NOT NULL` and `UNIQUE`. Using it as `PRIMARY KEY` eliminates an unnecessary column, simplifies foreign key relationships across future tables, and removes the need for an ID translation layer in API responses.

Performance trade-off (string PK vs integer PK) is negligible at the current scale.

### Migration `000004`

```sql
-- up
ALTER TABLE users DROP COLUMN id;
ALTER TABLE users ADD PRIMARY KEY (clerk_id);
```

```sql
-- down
ALTER TABLE users DROP CONSTRAINT users_pkey;
ALTER TABLE users ADD COLUMN id BIGSERIAL PRIMARY KEY;
```

> Note: the down migration adds `id` back but cannot restore original auto-increment values for existing rows — acceptable for a development-stage project.

### Downstream changes

| Layer | Change |
|---|---|
| `queries/users.sql` | Remove `id` from `ListUsers` SELECT |
| `internal/db/models.go` | `User.ID int64` field removed (auto-generated by sqlc) |
| `internal/db/users.sql.go` | `ListUsersRow.ID` removed (auto-generated) |
| `main.go` | Remove `ID int64 \`json:"id"\`` from local `User` struct |

---

## Files Touched

| File | Action |
|---|---|
| `backend/main.go` | Modify — swap `user.deleted` handler + remove `ID` from `User` struct |
| `backend/queries/users.sql` | Modify — fix `ON CONFLICT`, remove `id` from `ListUsers` |
| `backend/migrations/000004_clerk_id_pk.up.sql` | Create |
| `backend/migrations/000004_clerk_id_pk.down.sql` | Create |
| `backend/internal/db/models.go` | Auto-generated by sqlc |
| `backend/internal/db/querier.go` | Auto-generated by sqlc |
| `backend/internal/db/users.sql.go` | Auto-generated by sqlc |
